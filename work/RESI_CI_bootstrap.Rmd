---
title: "Simulation analysis evaluating bootstrapped CIs for RESI in a simple scenario"
author: "Kaidi Kang"
date: "6/29/2021"
output: 
  html_document:
    toc: true
    number_sections: true
    use_bookdown: yes
    code_folding: hide
    toc_float: 
      collapsed: false

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Abstract
This report is used to summarize the performances of CIs for RESI constructed via different bootstraps.\

Simple case situations will be considered:\

  + only 1 covariate and no nuisance covariates
  + Std Normal distribution

```{r}
# packages
library(magrittr)
library(lattice)
# devtools::install_github("cran/car")
library(car)
# source functions
# source("../RESI-master/R/nccd.R") 
# ## read function for CI for non-central F distribution
# source("ncf.R")
source("../R/boot.ci.R")
```


## Simulations

```{r,eval=FALSE}
SimFunc <- function(n = 100, r = 1000, alpha = 0.05, m = 1, S = 0.6, shape, hetero = TRUE, multi, boot.type, fixed_covariate, pi = 0.3, num.cores = 10){
  
  # simulate x and y
  if (fixed_covariate == TRUE) {
    sequence = rep(0:1, times = m*c(n - ceiling(n*pi), ceiling(n*pi)))
    x = sample(sequence, replace = FALSE) %>% matrix(nrow = n, ncol = m)
  } else {
    x = rbinom(n*m, 1, pi) %>% matrix(nrow = n, ncol = m)
  }
  
  if (hetero == TRUE) {
    sigma2 = 0.2 # the true var of errors
    errors = rgamma(n, shape = sigma2* shape, rate = sqrt(shape / (x[,1] + 0.5) ) ) - sigma2*sqrt(shape * (x[,1]+ 0.5) ) # depends on the 1st covariate
  } else {
    errors = rgamma(n, shape = sigma2* shape, rate = sqrt(shape) ) - sigma2* sqrt(shape)
  }
  
  xTx = sum(x^2)
  # true beta
  beta = sqrt( sigma2 * n * S^2 / xTx ) 
  # generate values of y
  y = x %*% beta + errors
  
  # fit the model
  model <- lm(y ~ x)
  # estimated beta
  beta.hat <- coef(model)
  
  # 1. when sigma is known (sigma = 1)
  # S.hat.norm <- sqrt(beta.hat^2)
  # bias.norm <- S.hat.norm - S
  
  # Constructing the CIs for 
  # z = beta.hat/sqrt(1/sum(x^2)) # normal dist
  # chi = z^2 # Chi-sq (1)
  # # CI for RESI
  # varcovx = solve(t(x) %*% x)

  # when sigma in unknwon
  # 2. naive estimator for sigma^2
  result.t <- boot.ci(model.full = lm(y ~ x) , r = r, method  = "F", multi = multi, boot.type = boot.type, num.cores = num.cores)$anova %>% as.matrix
  S.CI.t = c(result.t[1, 5:6])
  S.hat.t = result.t[1, 4]
  bias.t <- S.hat.t - S
  
  # 3. using HC3 estimator
  result.robust = boot.ci(model.full = lm(y ~ x) , r = r, method  = "Chisq", multi = multi, boot.type = boot.type, num.cores = num.cores)$anova %>% as.matrix
  S.CI.robust = result.robust[1, 5:6]
  S.hat.robust = result.robust[1, 4]
  bias.robust <- S.hat.robust - S
  

  output = c(
             # t or F-dist
             S.hat.t, bias.t,
             S.CI.t,
             coverage.t = (S >= S.CI.t[1] & S <= S.CI.t[2]),
             # the probabilty/proportion of true S failling on the left or right of the CI
             LL.t.prob = S < S.CI.t[1],
             UL.t.prob = S > S.CI.t[2],
             # beta.cvg.t, 
             # robust
             S.hat.robust, bias.robust,
             S.CI.robust,
             coverage.robust = (S >= S.CI.robust[1] & S <= S.CI.robust[2]),
             # the probabilty/proportion of true S failling on the left or right of the CI
             LL.prob.robust = S < S.CI.robust[1],
             UL.prob.robust = S > S.CI.robust[2]
             # beta.cvg.robust
             )
  
  name_list1 = c("S.hat.", "Bias.", "LL.", "UL.", "coverage.", "LL.prob.", "UL.prob.")
  name_list2 = c("t", "robust")
  
  names(output) = c(paste0(rep(name_list1, times = length(name_list2)), 
                           rep(name_list2, each = length(name_list1))) )
  return(output)
} # end of SimFunc()

# test
SimFunc(multi = 'none', shape = 100, boot.type = 1, num.cores = 1, fixed_covariate = FALSE)
```


```{r, eval=FALSE}
set.seed(1213)
nsim = 100 # outter loop
r = 500 # inner loop
alpha = 0.05
ns = c(50, 100, 250)
Ss = c(0, 0.1, 0.4, 0.6)
heteros = c(TRUE, FALSE) # hetero/homo-skedasticity
shape = c(0.1, 100) # skewness

multis = c('none', 'rad', 'normal')
boot.types = 1:4
num.cores = 16

# n = 50; S = 0; multi = 'none'; boot.type = 1

out = expand.grid(n = ns, S = Ss, multi = multis, boot.type = boot.types)
names <- SimFunc(n = 10, S = 0.1, multi = 'none', boot.type = 1, num.cores = 1) %>% names()

for (n in ns){
  for (S in Ss){
    for (multi in multis) {
      for (boot.type in boot.types){
        
        if (multi == 'none' & boot.type == 4) next
        
        message(paste(n, S, multi, boot.type), collapse = ",")
        
        temp <- simplify2array(
          mclapply(1:nsim, function(simInd, n, S, multi, boot.type){ 
                                    SimFunc(n = n, S = S, multi = multi, boot.type = boot.type, num.cores = 1) 
                                    }, 
                   mc.cores = num.cores, n = n, S = S, multi = multi, boot.type = boot.type )
        ) %>% t()
        
        out[which(out$n == n & out$S == S & 
                    out$multi == multi & out$boot.type == boot.type), names] <- colMeans(temp)
      }
    }
  }
}
```

```{r}
# write.csv(out, "CIs_Simple_Case_bootstrap_Jul6.csv")
```


# Plots
```{r}
out <- read.csv("CIs_Simple_Case_bootstrap_Jul6.csv", header = TRUE)
out$S_lab = paste("S =", out$S) # convert to label string
out$boot.type_lab <- paste("Bootstrap = ", out$boot.type)
```

## S = 0
```{r, fig.height=7}
# S = 0
trellis.device(color=FALSE, new=FALSE)

test = xyplot(coverage.t + coverage.robust ~ n | multi*boot.type_lab , 
              data= subset(out, S == 0),
              type='b', lwd=2,
              ylab='Coverage', xlab = 'Sample size',
              ylim = c(0.85, 1.02),
              panel= function(x, y, ...){
                panel.grid()
                panel.xyplot(x, y, ..., col='black')
                panel.abline(h=0.95, col='gray', ..., lty=2)
                }, 
              main='CI coverage (S = 0)',
              key = list(columns = 2,
                         text = list(lab = c( "t", "robust")),
                         points = list(pch =c(3, 6)))
              )
print(test)
```

## S = 0.1

```{r, fig.height=7}
# S = 0.1
trellis.device(color=FALSE, new=FALSE)

test = xyplot(coverage.t + coverage.robust ~ n | multi*boot.type_lab , 
              data= subset(out, S == 0.1),
              type='b', lwd=2,
              ylab='Coverage', xlab = 'Sample size',
              ylim = c(0.85, 1.02),
              panel= function(x, y, ...){
                panel.grid()
                panel.xyplot(x, y, ..., col='black')
                panel.abline(h=0.95, col='gray', ..., lty=2)
                }, 
              main='CI coverage (S = 0.1)',
              key = list(columns = 2,
                         text = list(lab = c( "t", "robust")),
                         points = list(pch =c(3, 6)))
              )
print(test)
```

## S = 0.4

```{r, fig.height=7}
# S = 0.4
trellis.device(color=FALSE, new=FALSE)

test = xyplot(coverage.t + coverage.robust ~ n | multi*boot.type_lab , 
              data= subset(out, S == 0.4),
              type='b', lwd=2,
              ylab='Coverage', xlab = 'Sample size',
              ylim = c(0.85, 1.02),
              panel= function(x, y, ...){
                panel.grid()
                panel.xyplot(x, y, ..., col='black')
                panel.abline(h=0.95, col='gray', ..., lty=2)
                }, 
              main='CI coverage (S = 0.4)',
              key = list(columns = 2,
                         text = list(lab = c( "t", "robust")),
                         points = list(pch =c(3, 6)))
              )
print(test)
```








## S = 0.6

```{r, fig.height=7}
# S = 0.6
trellis.device(color=FALSE, new=FALSE)

test = xyplot(coverage.t + coverage.robust ~ n | multi*boot.type_lab , 
              data= subset(out, S == 0.6),
              type='b', lwd=2,
              ylab='Coverage', xlab = 'Sample size',
              ylim = c(0.85, 1.02),
              panel= function(x, y, ...){
                panel.grid()
                panel.xyplot(x, y, ..., col='black')
                panel.abline(h=0.95, col='gray', ..., lty=2)
                }, 
              main='CI coverage (S = 0.6)',
              key = list(columns = 2,
                         text = list(lab = c( "t", "robust")),
                         points = list(pch =c(1, 3)))
              )
print(test)
```
